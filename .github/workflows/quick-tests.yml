name: Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ Ð¢ÐµÑÑ‚Ñ‹ âš¡

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  smoke-tests:
    name: Smoke Tests - Ð‘Ð°Ð·Ð¾Ð²Ð°Ñ Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ ðŸ”¥
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: ðŸ“¥ ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      uses: actions/checkout@v4

    - name: ðŸ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      run: |
        python -m pip install --upgrade pip
        pip install pytest pandas numpy streamlit

    - name: ðŸ”¥ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Smoke Tests
      run: |
        pytest tests/test_quick_validation.py -v -m smoke --tb=line

    - name: ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Smoke Tests
      if: always()
      run: |
        echo "## ðŸ”¥ Smoke Tests - Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹!" >> $GITHUB_STEP_SUMMARY

  structure-tests:
    name: CI Tests - Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° ÐŸÑ€Ð¾ÐµÐºÑ‚Ð° ðŸ—ï¸
    runs-on: ubuntu-latest
    needs: smoke-tests

    steps:
    - name: ðŸ“¥ ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      uses: actions/checkout@v4

    - name: ðŸ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      run: |
        python -m pip install --upgrade pip
        pip install pytest pandas numpy streamlit

    - name: ðŸ—ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
      run: |
        pytest tests/test_quick_validation.py -v -m ci --tb=line

    - name: ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ CI Tests
      if: always()
      run: |
        echo "## ðŸ—ï¸ CI Tests - Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ð°!" >> $GITHUB_STEP_SUMMARY

  full-validation:
    name: ÐŸÐ¾Ð»Ð½Ð°Ñ Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ - Ð’ÑÐµ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ Ð¢ÐµÑÑ‚Ñ‹ ðŸŽ¯
    runs-on: ubuntu-latest
    needs: [smoke-tests, structure-tests]

    steps:
    - name: ðŸ“¥ ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      uses: actions/checkout@v4

    - name: ðŸ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ðŸŽ¯ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹
      run: |
        pytest tests/test_quick_validation.py -v --tb=short

    - name: ðŸ“Š Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
      if: always()
      run: |
        echo "## ðŸŽ¯ ÐŸÐ¾Ð»Ð½Ð°Ñ Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ - Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Ð’ÑÐµ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹!" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ð°Ñ Ð¡Ð²Ð¾Ð´ÐºÐ° ðŸ“‹
    runs-on: ubuntu-latest
    needs: [smoke-tests, structure-tests, full-validation]
    if: always()

    steps:
    - name: ðŸ“‹ Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¸Ñ‚Ð¾Ð³Ð¾Ð²ÑƒÑŽ ÑÐ²Ð¾Ð´ÐºÑƒ
      run: |
        echo "# ðŸŽ¯ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ð¢ÐµÑÑ‚Ð¾Ð²" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¾Ðº:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° | Ð¡Ñ‚Ð°Ñ‚ÑƒÑ |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”¥ Smoke Tests | ${{ needs.smoke-tests.result == 'success' && 'âœ… ÐŸÑ€Ð¾Ð¹Ð´ÐµÐ½Ð¾' || 'âŒ ÐŸÑ€Ð¾Ð²Ð°Ð»ÐµÐ½Ð¾' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ—ï¸ CI Tests | ${{ needs.structure-tests.result == 'success' && 'âœ… ÐŸÑ€Ð¾Ð¹Ð´ÐµÐ½Ð¾' || 'âŒ ÐŸÑ€Ð¾Ð²Ð°Ð»ÐµÐ½Ð¾' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ¯ ÐŸÐ¾Ð»Ð½Ð°Ñ Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ | ${{ needs.full-validation.result == 'success' && 'âœ… ÐŸÑ€Ð¾Ð¹Ð´ÐµÐ½Ð¾' || 'âŒ ÐŸÑ€Ð¾Ð²Ð°Ð»ÐµÐ½Ð¾' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ð±Ñ‰ÐµÐ³Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
        if [[ "${{ needs.smoke-tests.result }}" == "success" ]] && \
           [[ "${{ needs.structure-tests.result }}" == "success" ]] && \
           [[ "${{ needs.full-validation.result }}" == "success" ]]; then
          echo "## âœ… Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ÐšÐ¾Ð´ Ð³Ð¾Ñ‚Ð¾Ð² Ðº merge! ðŸš€" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð½Ðµ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ Ð²Ñ‹ÑˆÐµ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹." >> $GITHUB_STEP_SUMMARY
        fi
